# RAG Система "Вопрос-Ответ"

Это проект вопросно-ответной системы (RAG), предназначенной для поиска информации по большой базе технических документов. Система использует современные ML-модели для обеспечения точных и релевантных ответов на основе предоставленных источников.

## Архитектура

Система состоит из двух основных сервисов:

1.  **FastAPI Backend (`src/api`)**: Асинхронный API-сервис, который реализует всю RAG-логику:
    *   Прием запросов от пользователей.
    *   Генерация эмбеддингов для запросов.
    *   Выполнение гибридного поиска (векторного + полнотекстового) в базе данных PostgreSQL с расширением `pgvector`.
    *   Ре-ранжирование найденных кандидатов для повышения релевантности.
    *   Формирование промпта для LLM с найденным контекстом.
    *   Взаимодействие с OpenAI-совместимой LLM для генерации ответа.
    *   Сохранение истории запросов.

2.  **Django Frontend (`src/web`)**: Традиционное веб-приложение, предоставляющее пользовательский интерфейс:
    *   Аутентификация и управление пользователями.
    *   Форма для отправки вопросов к RAG-системе.
    *   Отображение истории запросов пользователя с возможностью поиска.

Оба сервиса работают с единой базой данных **PostgreSQL 15**.

## Технологический стек

*   **Бэкенд**: Python 3.11+, FastAPI
*   **Фронтенд**: Python 3.11+, Django
*   **База данных**: PostgreSQL 15 + `pgvector`
*   **ML-модели**:
    *   Эмбеддинги: `BAAI/bge-m3`
    *   Ре-ранжирование: `BAAI/bge-reranker-v2-m3`
*   **Окружение**: `virtualenv` + `pip`
*   **Инструменты**: `ruff` (форматтер и линтер), `pytest` (тестирование)

## Установка и запуск

### 1. Предварительные требования

*   Python 3.11+
*   PostgreSQL 15
*   Установленное расширение `pgvector` для PostgreSQL.

### 2. Установка зависимостей

Все зависимости проекта управляются через `pyproject.toml`.

```bash
# 1. Создайте и активируйте виртуальное окружение
python3 -m venv .venv
source .venv/bin/activate

# 2. Установите все необходимые пакеты
pip install -e ".[dev]"

# 3. Скопируйте файл с переменными окружения
cp .env.example .env

# 4. (Опционально) Отредактируйте .env, указав свои настройки для БД и LLM
# nano .env
```

### 3. Настройка базы данных

Схема базы данных и все необходимые таблицы создаются с помощью DDL-скрипта.

```bash
# Убедитесь, что ваш пользователь PostgreSQL имеет права на создание БД
# или выполните команду от имени суперпользователя postgres.
# Замените <user> и <password> на ваши значения из .env
psql -U <user> -c "CREATE DATABASE rag_docs;"
psql -U <user> -d rag_docs -f scripts/setup_db.sql
```

### 4. Запуск сервисов для разработки

*   **FastAPI API**:
    ```bash
    uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8001
    ```

*   **Django Web UI**:
    ```bash
    # Сначала примените миграции Django для внутренних моделей (auth, sessions)
    python src/web/manage.py migrate

    # Создайте суперпользователя для доступа к админ-панели
    python src/web/manage.py createsuperuser

    # Запустите сервер
    python src/web/manage.py runserver 0.0.0.0:8000
    ```

После запуска сервисов, веб-интерфейс будет доступен по адресу `http://localhost:8000`, а API — `http://localhost:8001`.

## Тестирование

Для запуска тестов используется `pytest`.

```bash
# Запуск всех тестов
pytest

# Запуск тестов для конкретного файла
pytest tests/test_chunker.py
pytest tests/test_api.py
```

Текущее покрытие тестами:
*   `tests/test_chunker.py`: Реализованы юнит-тесты для `MarkdownChunker`.
*   `tests/test_api.py`: Реализованы базовые интеграционные тесты для эндпоинта `/api/v1/query` с использованием моков.

## Ingestion Pipeline

Для загрузки ваших документов в систему используется специальный CLI-скрипт.

```bash
# Пример команды для загрузки документов
python -m src.ingestion.cli --input /path/to/your/markdown/files --domain "my-docs"

## HTML to Markdown Converter

Для конвертации HTML-документов в формат Markdown используется специальный инструмент в модуле `src/convert/`. Это позволяет подготовить документы в нужном формате для последующей загрузки в систему.

```bash
# Пример команды для конвертации HTML-файлов в Markdown
python -m src.convert.cli --input /path/to/html/files --output /path/to/output/markdown/files
```

Конвертер использует библиотеки `trafilatura`, `beautifulsoup4` и `markdownify` для извлечения основного контента из HTML и преобразования его в Markdown, при этом удаляя ненужные элементы (навигация, футеры, рекламные блоки и т.д.).